<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Video Call</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
    <h1>WebRTC Video Call</h1>

    <!-- Registration Form -->
    <div id="registration">
        <h2>Register</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="register()">Register</button>
        <div id="registration-status"></div>
    </div>

    <!-- Contact Management -->
    <div id="contact-management">
        <h2>Add Contact</h2>
        <input type="text" id="contact" placeholder="Contact Username">
        <button onclick="addContact()">Add Contact</button>
        <div id="contact-status"></div>
    </div>

    <!-- Video Elements -->
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>

    <script>
        // Your JavaScript code goes here
        const socket = io();
        const secretKey = '1234';  // Encryption key

        let localStream;
        let peerConnection;
        let username;

        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');

        // Register a user
        function register() {
            username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            }).then(response => response.text())
              .then(result => {
                document.getElementById('registration-status').innerText = result;
                if (result === 'User registered') {
                    socket.emit('register', username);
                }
            });
        }

        // Add a contact
        function addContact() {
            const contact = document.getElementById('contact').value;
            fetch('/add-contact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, contact })
            }).then(response => response.text())
              .then(result => {
                document.getElementById('contact-status').innerText = result;
            });
        }

        // Get user media
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                localVideo.srcObject = stream;
                console.log('Local stream initialized');
                socket.emit('ready');
            })
            .catch(error => {
                console.error('Error accessing media devices:', error);
            });

        // Create peer connection
        socket.on('ready', () => {
            peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            peerConnection.addStream(localStream);

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    const encryptedCandidate = CryptoJS.AES.encrypt(
                        JSON.stringify({ to: username, candidate: event.candidate }),
                        secretKey
                    ).toString();
                    socket.emit('candidate', encryptedCandidate);
                    console.log('ICE candidate sent');
                }
            };

            peerConnection.onaddstream = event => {
                remoteVideo.srcObject = event.stream;
                console.log('Remote stream added');
            };

            // Handle incoming offer
            socket.on('offer', data => {
                try {
                    const { from, offer } = JSON.parse(
                        CryptoJS.AES.decrypt(data, secretKey).toString(CryptoJS.enc.Utf8)
                    );
                    peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    peerConnection.createAnswer()
                        .then(answer => {
                            peerConnection.setLocalDescription(answer);
                            const encryptedAnswer = CryptoJS.AES.encrypt(
                                JSON.stringify({ to: from, answer }),
                                secretKey
                            ).toString();
                            socket.emit('answer', encryptedAnswer);
                            console.log('Answer sent');
                        });
                } catch (error) {
                    console.error('Failed to process offer:', error);
                }
            });

            // Handle incoming answer
            socket.on('answer', data => {
                try {
                    const { from, answer } = JSON.parse(
                        CryptoJS.AES.decrypt(data, secretKey).toString(CryptoJS.enc.Utf8)
                    );
                    peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    console.log('Answer processed');
                } catch (error) {
                    console.error('Failed to process answer:', error);
                }
            });

            // Handle incoming ICE candidates
            socket.on('candidate', data => {
                try {
                    const { from, candidate } = JSON.parse(
                        CryptoJS.AES.decrypt(data, secretKey).toString(CryptoJS.enc.Utf8)
                    );
                    peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    console.log('ICE candidate added');
                } catch (error) {
                    console.error('Failed to process ICE candidate:', error);
                }
            });
        });
    </script>
</body>
</html>
